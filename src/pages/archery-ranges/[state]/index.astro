---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Breadcrumbs from '../../../components/Breadcrumbs.astro';
import { getRangesByState, getCitySlug } from '../../../data/ranges';
import { FEATURES } from '../../../data/filters';
import { makeTitle, makeDescription } from '../../../utils/seo';

export async function getStaticPaths() {
  const byState = getRangesByState();
  return [...byState.entries()].map(([stateSlug, ranges]) => ({
    params: { state: stateSlug },
    props: { stateName: ranges[0].state, ranges },
  }));
}

const { state: stateSlug } = Astro.params;
const { stateName, ranges } = Astro.props;

const cityCounts = new Map<string, { name: string; slug: string; count: number }>();
for (const r of ranges) {
  const slug = getCitySlug(r.city);
  if (!cityCounts.has(slug)) cityCounts.set(slug, { name: r.city, slug, count: 0 });
  cityCounts.get(slug)!.count++;
}
const cities = [...cityCounts.values()].sort((a, b) => b.count - a.count);

const schema = {
  '@context': 'https://schema.org',
  '@type': 'CollectionPage',
  name: makeTitle('state', { state: stateName, count: ranges.length }),
  description: makeDescription('state', { state: stateName, count: ranges.length }),
  url: new URL(`/archery-ranges/${stateSlug}/`, Astro.site).toString(),
};
---

<BaseLayout
  title={makeTitle('state', { state: stateName, count: ranges.length })}
  description={makeDescription('state', { state: stateName, count: ranges.length })}
>
  <script type="application/ld+json" set:html={JSON.stringify(schema)} />

  <Breadcrumbs crumbs={[{ label: stateName }]} />

  <h1 class="font-display text-4xl sm:text-5xl font-bold text-ink mb-3">
    Archery Ranges in {stateName}
  </h1>
  <p class="text-stone text-lg mb-10">{ranges.length} ranges found.</p>

  <h2 class="font-display text-2xl font-semibold text-ink mb-5">Browse by City</h2>
  <ul class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 mb-14">
    {cities.map(c => (
      <li>
        <a
          href={`/archery-ranges/${stateSlug}/${c.slug}/`}
          class="group block bg-cream-dark border border-tan rounded-xl px-4 py-3 hover:border-forest hover:shadow-sm transition-all"
        >
          <span class="font-medium text-forest text-sm block">{c.name}</span>
          <span class="text-xs text-stone mt-0.5 block">{c.count} range{c.count !== 1 ? 's' : ''} â†’</span>
        </a>
      </li>
    ))}
  </ul>

  <h2 class="font-display text-2xl font-semibold text-ink mb-4">Filter by Type</h2>
  <ul class="flex flex-wrap gap-2">
    {FEATURES.map(f => (
      <li>
        <a
          href={`/archery-ranges/${stateSlug}/${f.slug}/`}
          class="inline-block bg-cream-dark border border-tan text-forest text-sm px-4 py-2 rounded-full hover:bg-forest hover:text-white hover:border-forest transition-all font-medium"
        >
          {f.label}
        </a>
      </li>
    ))}
  </ul>
</BaseLayout>
